{% extends "base.html" %}

{% block title %}Cadastro - E-Commerce{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
  <div class="col-lg-8 col-xl-6">
    <div class="card shadow">
      <div class="card-header bg-success text-white text-center">
        <h4 class="mb-0"><i class="fas fa-user-plus"></i> Criar Nova Conta</h4>
      </div>

      <div class="card-body p-4">
        <form method="POST"
              action="{{ url_for('cadastro') }}"
              class="needs-validation"
              novalidate>
          <div class="row g-3">
            <!-- Nome -->
            <div class="col-md-6">
              <label for="nome" class="form-label">Nome Completo *</label>
              <div class="input-group has-validation">
                <span class="input-group-text"><i class="fas fa-user"></i></span>
                <input type="text"
                       class="form-control"
                       id="nome"
                       name="nome"
                       placeholder="Ex.: Maria da Silva"
                       value="{{ request.form.get('nome','') }}"
                       autocomplete="name"
                       required
                       minlength="3"
                       aria-describedby="nomeHelp">
                <div class="invalid-feedback">Informe seu nome (mínimo 3 caracteres).</div>
              </div>
              <div id="nomeHelp" class="form-text">Como aparece em seus documentos.</div>
            </div>

            <!-- E-mail -->
            <div class="col-md-6">
              <label for="email" class="form-label">E-mail *</label>
              <div class="input-group has-validation">
                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                <input type="email"
                       class="form-control"
                       id="email"
                       name="email"
                       placeholder="voce@exemplo.com"
                       value="{{ request.form.get('email','') }}"
                       autocomplete="email"
                       required>
                <div class="invalid-feedback">Informe um e-mail válido.</div>
              </div>
            </div>

            <!-- Senha -->
            <div class="col-md-6">
              <label for="senha" class="form-label">Senha *</label>
              <div class="input-group has-validation">
                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                <input type="password"
                       class="form-control"
                       id="senha"
                       name="senha"
                       placeholder="Crie uma senha"
                       autocomplete="new-password"
                       required
                       minlength="6"
                       aria-describedby="senhaHelp">
                <button class="btn btn-outline-secondary" type="button" id="toggleSenha" aria-label="Mostrar/ocultar senha">
                  <i class="far fa-eye"></i>
                </button>
                <div class="invalid-feedback">A senha deve ter no mínimo 6 caracteres.</div>
              </div>
              <div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar" id="senhaStrength" role="progressbar" style="width: 0%"></div>
              </div>
              <div id="senhaHelp" class="form-text">Use letras maiúsculas, minúsculas, números e símbolos.</div>
            </div>

            <!-- Telefone -->
            <div class="col-md-6">
              <label for="telefone" class="form-label">Telefone</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                <input type="tel"
                       class="form-control"
                       id="telefone"
                       name="telefone"
                       inputmode="tel"
                       placeholder="(11) 99999-9999"
                       value="{{ request.form.get('telefone','') }}"
                       autocomplete="tel">
              </div>
              <div class="form-text">Opcional — facilita contato com vendedores/compradores.</div>
            </div>

            <!-- Endereço -->
            <div class="col-12">
              <label for="endereco" class="form-label">Endereço Completo</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                <textarea class="form-control"
                          id="endereco"
                          name="endereco"
                          rows="3"
                          placeholder="Rua, número, bairro, cidade, estado, CEP"
                          autocomplete="street-address">{{ request.form.get('endereco','') }}</textarea>
              </div>
            </div>

            <!-- Termos -->
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       id="termos"
                       required>
                <label class="form-check-label" for="termos">
                  Eu concordo com os
                  <a href="#" class="text-decoration-none">termos de uso</a>
                  e
                  <a href="#" class="text-decoration-none">política de privacidade</a>.
                </label>
                <div class="invalid-feedback">Você precisa aceitar os termos para continuar.</div>
              </div>
            </div>

            <!-- Botão -->
            <div class="col-12 d-grid">
              <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-user-plus"></i> Criar Conta
              </button>
            </div>
          </div>
        </form>

        <hr>

        <div class="text-center">
          <p class="text-muted mb-2">Já tem uma conta?</p>
          <a href="{{ url_for('login') }}" class="btn btn-outline-primary">
            <i class="fas fa-sign-in-alt"></i> Fazer Login
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Validação visual Bootstrap
  (function () {
    'use strict';
    const form = document.querySelector('.needs-validation');
    if (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    }
  })();

  // Máscara para telefone
  (function () {
    const tel = document.getElementById('telefone');
    if (!tel) return;
    tel.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 11) value = value.slice(0, 11);
      if (value.length >= 11) {
        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
      } else if (value.length >= 7) {
        value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
      } else if (value.length >= 3) {
        value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
      } else if (value.length >= 1) {
        value = value.replace(/(\d*)/, '($1');
      }
      e.target.value = value;
    });
  })();

  // Mostrar/Ocultar senha + medidor de força
  (function () {
    const senha = document.getElementById('senha');
    const toggle = document.getElementById('toggleSenha');
    const bar = document.getElementById('senhaStrength');

    if (toggle && senha) {
      toggle.addEventListener('click', function () {
        const isPwd = senha.getAttribute('type') === 'password';
        senha.setAttribute('type', isPwd ? 'text' : 'password');
        this.querySelector('i').classList.toggle('fa-eye');
        this.querySelector('i').classList.toggle('fa-eye-slash');
      });
    }

    function scorePassword(pwd) {
      let score = 0;
      if (!pwd) return 0;
      // Comprimento
      score += Math.min(6, pwd.length) * 8; // até 48
      // Diversidade de caracteres
      if (/[a-z]/.test(pwd)) score += 12;
      if (/[A-Z]/.test(pwd)) score += 12;
      if (/\d/.test(pwd)) score += 12;
      if (/[^A-Za-z0-9]/.test(pwd)) score += 16; // símbolos
      return Math.min(score, 100);
    }

    if (senha && bar) {
      senha.addEventListener('input', function () {
        const v = senha.value;
        const s = scorePassword(v);
        bar.style.width = s + '%';
        // classes de cor
        bar.classList.remove('bg-danger', 'bg-warning', 'bg-success');
        if (s < 40) bar.classList.add('bg-danger');
        else if (s < 75) bar.classList.add('bg-warning');
        else bar.classList.add('bg-success');
      });
    }
  })();
</script>
{% endblock %}
